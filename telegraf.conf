# =====================================
# Telegraf Configuration for MQTT → InfluxDB
# =====================================

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  flush_interval = "10s"
  flush_jitter = "0s"
  collection_jitter = "0s"
  precision = ""
  omit_hostname = true

# =====================================
# INPUT PLUGIN: MQTT Consumer
# =====================================
[[inputs.mqtt_consumer]]
  # Use TLS
  servers = ["ssl://emqx:8883"]

  # Topics allowed by your ACL
  topics = ["factory/+/+/telemetry"]
  # or: topics = ["$share/telegraf/factory/office/+/telemetry"]

  # Auth
  username  = "telegraf"
  password  = "telegraf123"

  # TLS — point to your CA
  tls_ca = "/etc/telegraf/certs/ca-cert.pem"
  insecure_skip_verify = false

  qos = 1
  client_id = "telegraf-mqtt-simulator-listener"
  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "2006-01-02T15:04:05Z07:00"
  json_name_key = "client_id"
  tag_keys = ["client_id"]
# =====================================
# OUTPUT PLUGIN: InfluxDB v2
# =====================================
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "iot-admin-token-123"
  organization = "iot-org"
  bucket = "iot-data"

  timeout = "5s"
  content_encoding = "gzip"

# =====================================
# (Optional) System Metrics (for debugging)
# =====================================
#[[inputs.cpu]]
#  percpu = true
#  totalcpu = true

#[[inputs.mem]]
#[[inputs.disk]]
#[[inputs.diskio]]
#[[inputs.net]]

# =====================================
# Logging Output (debugging)
# =====================================
[[outputs.file]]
  files = ["stdout"]
  data_format = "json"
