import os
import time
import json
import ssl
from datetime import datetime, timedelta, timezone

import numpy as np
import pandas as pd
import paho.mqtt.client as mqtt

# --- Timezone (UTC+07) ---
UTC_PLUS_7 = timezone(timedelta(hours=7))

# --- Paths ---
BASE_DIR = os.path.dirname(__file__)
CSV_PATH = os.path.join(BASE_DIR, "MitM.csv")
CA_PATH = os.path.join(BASE_DIR, "certs", "ca-cert.pem")

# --- MQTT / EMQX settings ---
BROKER_HOST = "10.12.112.191"
BROKER_PORT = 8883

TENANT = "office"
DEVICE_ID = "office-sensorhum7-replayer"   # matches your ACL username
CLIENT_ID = DEVICE_ID
USERNAME = DEVICE_ID
PASSWORD = "hum123"

# Map ONLY the topics you want this client to publish
TOPIC_MAP = {
    # source_topic in CSV : destination topic on your broker
    "distance/ultrasonic1": f"factory/{TENANT}/{DEVICE_ID}/telemetry",
    # if later you want light topics, add them here with a proper ACL
}


def make_client() -> mqtt.Client:
    client = mqtt.Client(client_id=CLIENT_ID, clean_session=True)
    client.username_pw_set(USERNAME, PASSWORD)

    ctx = ssl.create_default_context(ssl.Purpose.SERVER_AUTH, cafile=CA_PATH)
    ctx.check_hostname = True          # or False if cert CN doesn't match host
    ctx.verify_mode = ssl.CERT_REQUIRED
    client.tls_set_context(ctx)

    client.connect(BROKER_HOST, BROKER_PORT, keepalive=60)
    return client


# --- Load CSV and select MQTT PUBLISH packets ---
df = pd.read_csv(CSV_PATH, low_memory=False)

rows = df[(df["mqtt.msgtype"] == 3) & df["mqtt.topic"].notna()].copy()
rows = rows.sort_values("frame.time_relative")

# Inter-message intervals (seconds)
t = rows["frame.time_relative"].values
intervals = np.diff(t, prepend=t[0])

client = make_client()
client.loop_start()

try:
    for (idx, row), dt in zip(rows.iterrows(), intervals):
        src_topic = row["mqtt.topic"]

        # âœ… Only replay topics we have mapped (skips light/rele1 etc.)
        if src_topic not in TOPIC_MAP:
            continue

        dst_topic = TOPIC_MAP[src_topic]

        # Respect original timing
        if dt > 0:
            time.sleep(dt)

        qos = int(row["mqtt.qos"] or 0)
        retain = bool(row["mqtt.retain"])

        # Skip if no numeric payload
        if pd.isna(row["mqtt.msg"]):
            continue
        value = float(row["mqtt.msg"])

        payload = {
            "timestamp": datetime.now(UTC_PLUS_7).isoformat(),
            "value": value,
            "label": row["type"],  # "normal" or "mitm"
        }

        print(f"[{idx}] Publishing to {dst_topic}: {payload}")
        client.publish(dst_topic, json.dumps(payload), qos=qos, retain=retain)

finally:
    client.loop_stop()
    client.disconnect()
